@model PhuLieuToc.Models.CategoryModel
@{
    ViewData["Title"] = "Chỉnh sửa danh mục con";
    Layout = "_Layout";
}

<div class="container">
    <h1>Chỉnh sửa danh mục con: @Model.TenDanhMuc</h1>
    <form id="editSubcategoryForm">
        @Html.AntiForgeryToken()
        <div class="mb-3">
            <label for="name" class="form-label">Tên danh mục con</label>
            <input type="text" class="form-control" id="name" value="@Model.TenDanhMuc" required />
        </div>
        <div class="mb-3">
            <label for="slug" class="form-label">Slug</label>
            <input type="text" class="form-control" id="slug" value="@Model.Slug" />
            <small class="form-text text-muted">Slug sẽ được tạo tự động từ tên danh mục</small>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Mô tả</label>
            <textarea class="form-control" id="description">@Model.MoTa</textarea>
        </div>
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="active" @(Model.TrangThai == 1 ? "checked" : "") />
            <label class="form-check-label" for="active">Đang hoạt động</label>
        </div>
        <button type="submit" class="btn btn-success">Lưu</button>
        <a href="/Admin/DanhMuc/Subcategories/@Model.ParentCategoryId" class="btn btn-secondary">Quay lại</a>
    </form>
</div>

@section Scripts {
    <script>
        const nameInput = document.getElementById('name');
        const slugInput = document.getElementById('slug');
        const descriptionInput = document.getElementById('description');
        const activeInput = document.getElementById('active');
        const form = document.getElementById('editSubcategoryForm');

        // Hàm tạo slug
        function generateSlug(text) {
            return text.toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // bỏ dấu tiếng Việt
                .replace(/đ/g, 'd').replace(/Đ/g, 'd')
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '') // bỏ ký tự đặc biệt
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        }

        // Auto tạo slug khi nhập tên
        nameInput.addEventListener('input', function () {
            slugInput.value = generateSlug(this.value);
        });

        // Submit form
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const data = {
                Name: nameInput.value,
                Slug: slugInput.value,
                Description: descriptionInput.value,
                Active: activeInput.checked
            };

            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const response = await fetch(`/Admin/DanhMuc/EditSubcategory/@Model.Id`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert(result.message);
                window.location.href = `/Admin/DanhMuc/Subcategories/@Model.ParentCategoryId`;
            } else {
                alert('Lỗi: ' + result.message);
            }
        });
    </script>
}
