@model IEnumerable<PhuLieuToc.Models.SanPham>

@{
    ViewData["Title"] = "Sản phẩm";
}

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                Sản phẩm
                @if (!string.IsNullOrEmpty(ViewBag.SelectedCategoryName))
                {
                    <span class="text-muted">- @ViewBag.SelectedCategoryName</span>
                }
            </h2>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Danh mục</label>
                            <select name="categoryId" class="form-select">
                                <option value="">Tất cả danh mục</option>
                                @foreach (var category in (List<PhuLieuToc.Models.CategoryModel>)ViewBag.Categories)
                                {
                                    var isSelected = ViewBag.SelectedCategoryId?.ToString() == category.Id.ToString();
                                    <option value="@category.Id" selected="@isSelected">
                                        @category.TenDanhMuc
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Thương hiệu</label>
                            <select name="brandId" class="form-select">
                                <option value="">Tất cả thương hiệu</option>
                                @foreach (var brand in (List<PhuLieuToc.Models.BrandModel>)ViewBag.Brands)
                                {
                                    var isSelected = ViewBag.SelectedBrandId?.ToString() == brand.Id.ToString();
                                    <option value="@brand.Id" selected="@isSelected">
                                        @brand.TenThuongHieu
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" name="search" class="form-control" placeholder="Nhập tên sản phẩm..." value="@ViewBag.SearchTerm">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    @if (Model.Any())
    {
        <div class="row">
            @foreach (var product in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card h-100 product-card">
                        <div class="product-image-container">
                            @{ var firstVariant = product.SanPhamChiTiets?.Where(v => v.TrangThai == 1).OrderBy(v => v.SanPhamChiTietId).FirstOrDefault(); }
                            @if (!string.IsNullOrEmpty(firstVariant?.Anh))
                            {
                                <img src="@Url.Content(firstVariant.Anh)" alt="@product.TenSanPham" class="card-img-top product-image" style="width:100%;height:200px;object-fit:cover;">
                            }
                            else
                            {
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center product-image">
                                    <i class="fas fa-image fa-2x text-muted"></i>
                                </div>
                            }
                            <div class="product-overlay">
                                @if (firstVariant != null) {
                                <a href="@Url.Action("Details", new { id = firstVariant.SanPhamChiTietId })" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Xem chi tiết
                                </a>
                                }
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">@product.TenSanPham</h6>
                            
                            @if (firstVariant?.SanPhamChiTietThuocTinhs != null && firstVariant.SanPhamChiTietThuocTinhs.Any())
                            {
                                <p class="card-text text-muted small">@string.Join(", ", firstVariant.SanPhamChiTietThuocTinhs.Select(t => t.GiaTriThuocTinh.TenGiaTri))</p>
                            }
                            
                            @if (!string.IsNullOrEmpty(product.Brand?.TenThuongHieu))
                            {
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-tag me-1"></i>@product.Brand.TenThuongHieu
                                    </small>
                                </p>
                            }
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="h5 text-primary mb-0">@(firstVariant?.Gia.ToString("N0") ?? "0") ₫</span>
                                    <small class="text-muted">Còn: @(firstVariant?.SoLuongTon ?? 0)</small>
                                </div>
                                
                                @if ((firstVariant?.SoLuongTon ?? 0) > 0)
                                {
                                    <button class="btn btn-outline-primary w-100" onclick="openVariantOrAdd(@product.SanPhamId, @firstVariant.SanPhamChiTietId)">
                                        <i class="fas fa-shopping-cart me-1"></i>Thêm vào giỏ
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-secondary w-100" disabled>
                                        <i class="fas fa-times me-1"></i>Hết hàng
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Không tìm thấy sản phẩm</h4>
                    <p class="text-muted">Hãy thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-refresh me-2"></i>Xem tất cả sản phẩm
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .product-card {
        transition: transform 0.2s ease-in-out;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .product-image-container {
        position: relative;
        overflow: hidden;
    }
    
    .product-image {
        height: 200px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .product-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .product-card:hover .product-overlay {
        opacity: 1;
    }
    
    .product-card:hover .product-image {
        transform: scale(1.1);
    }
</style>

@section Scripts {
    <script>
        // Update price to min-max like home
        document.querySelectorAll('.price-text').forEach(el => {
            const pid = el.getAttribute('data-product-id');
            if (!pid) return;
            fetch('@Url.Action("GetVariants","Product")' + `?productId=${pid}`)
                .then(r=>r.json()).then(d=>{
                    if (!d.success) return;
                    if (d.variants && d.variants.length > 1){
                        el.textContent = d.minPrice === d.maxPrice ? Number(d.minPrice).toLocaleString() : `${Number(d.minPrice).toLocaleString()} - ${Number(d.maxPrice).toLocaleString()}`;
                    }
                });
        });

        function addToCart(sanPhamChiTietId, selectedThuocTinhText = '') {
            fetch('@Url.Action("AddToCart", "Cart")', {
                method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `sanPhamChiTietId=${sanPhamChiTietId}&soLuong=1&selectedThuocTinh=${encodeURIComponent(selectedThuocTinhText)}`
            }).then(r=>r.json()).then(d=>{ if (d.success){ if (window.showToast) showToast(d.message,'success'); if (window.updateCartCount) updateCartCount(); } else alert(d.message||'Có lỗi');});
        }

        async function openVariantOrAdd(productId, defaultVariantId) {
            try {
                const res = await fetch('@Url.Action("GetVariants","Product")' + `?productId=${productId}`);
                const data = await res.json();
                if (!data.success) return addToCart(defaultVariantId);
                if (!data.variants || data.variants.length === 0) return addToCart(defaultVariantId);
                if (data.variants.length === 1) {
                    const onlyId = data.variants[0]?.id || defaultVariantId;
                    return addToCart(onlyId, data.variants[0]?.thuocTinh?.map(t=>`${t.loai}: ${t.giaTri}`).join(', '));
                }

                const variants = data.variants;
                const loaiToValues = {}; variants.forEach(v => { (v.thuocTinh||[]).forEach(t => { (loaiToValues[t.loai] ||= new Set()).add(String(t.giaTri)); }); });
                const loais = Object.keys(loaiToValues); const selected = {}; loais.forEach(l => { selected[l] = Array.from(loaiToValues[l])[0] || ''; });
                const html = `
<div class="modal fade variant-modal" id="variantModal" tabindex="-1" aria-hidden="true">
 <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Chọn biến thể</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
  <div class="modal-body">
    ${loais.map(loai => `
      <div class="mb-2" style="font-weight:600;color:var(--text-dark)">${loai}</div>
      <div class="variant-options" data-loai="${loai}">
        ${Array.from(loaiToValues[loai]).map(val => `<div class='variant-chip' data-value='${val}'><div style='font-size:14px;font-weight:600'>${val}</div></div>`).join('')}
      </div>`).join('')}
    <div class="mt-3 d-flex align-items-center justify-content-between">
      <div class="qty-control"><button type="button" id="qtyMinus">-</button><input type="number" id="qtyInput" value="1" min="1" /><button type="button" id="qtyPlus">+</button></div>
      <div id="pricePreview" style="font-weight:700;color:var(--primary-dark)"></div>
    </div>
  </div>
  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary" id="variantAddBtn">Thêm vào giỏ</button></div>
 </div></div>
</div>`;
                const container = document.createElement('div'); container.style.position='relative'; container.style.zIndex='1056'; container.innerHTML=html; document.body.appendChild(container);
                const modalEl = container.querySelector('#variantModal'); const modal = new bootstrap.Modal(modalEl,{backdrop:true,focus:true}); let selectedId=null; const pricePreview = container.querySelector('#pricePreview'); const qtyInput = container.querySelector('#qtyInput');
                container.querySelectorAll('.variant-options').forEach(g=>{ const c=g.querySelector('.variant-chip'); if(c) c.classList.add('active'); });
                function normalize(v){return String(v??'').trim().toLowerCase();}
                function findMatching(sel){ const keys=Object.keys(sel).filter(k=>sel[k]); if(!keys.length) return null; return variants.find(v=>{ const map={}; (v.thuocTinh||[]).forEach(t=>{ (map[t.loai] ||= new Set()).add(normalize(String(t.giaTri))); }); return keys.every(l=> map[l] && map[l].has(normalize(sel[l])) );}) || null; }
                function refresh(){ container.querySelectorAll('.variant-options').forEach(g=>{ const loai=g.getAttribute('data-loai'); const act=g.querySelector('.variant-chip.active'); if(loai&&act) selected[loai]=act.getAttribute('data-value'); }); const v=findMatching(selected); selectedId= v? v.id:null; pricePreview.textContent= v? (Number(v.gia).toLocaleString()+ ' đ') : '' }
                container.querySelectorAll('.variant-options .variant-chip').forEach(c=>{ c.addEventListener('click',()=>{ const p=c.closest('.variant-options'); const loai=p.getAttribute('data-loai'); const value=c.getAttribute('data-value'); p.querySelectorAll('.variant-chip').forEach(x=>x.classList.remove('active')); c.classList.add('active'); selected[loai]=value; refresh();});});
                refresh();
                container.querySelector('#variantAddBtn').addEventListener('click', ()=>{ refresh(); if(!selectedId){ if(window.showToast) showToast('Vui lòng chọn đủ thuộc tính','secondary'); return;} const selectedPairs = loais.map(l=>`${l}: ${selected[l]}`).join(', '); addToCart(selectedId, selectedPairs); modal.hide(); container.remove(); });
                modalEl.addEventListener('hidden.bs.modal',()=>container.remove()); modal.show();
            } catch(e){ addToCart(defaultVariantId); }
        }
    </script>
}