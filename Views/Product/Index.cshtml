@model IEnumerable<PhuLieuToc.Models.SanPham>

@{
    ViewData["Title"] = "Sản phẩm";
}

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                Sản phẩm
                @if (!string.IsNullOrEmpty(ViewBag.SelectedCategoryName))
                {
                    <span class="text-muted">- @ViewBag.SelectedCategoryName</span>
                }
            </h2>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Danh mục</label>
                            <select name="categoryId" class="form-select">
                                <option value="">Tất cả danh mục</option>
                                @foreach (var category in (List<PhuLieuToc.Models.CategoryModel>)ViewBag.Categories)
                                {
                                    var isSelected = ViewBag.SelectedCategoryId?.ToString() == category.Id.ToString();
                                    <option value="@category.Id" selected="@isSelected">
                                        @category.TenDanhMuc
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Thương hiệu</label>
                            <select name="brandId" class="form-select">
                                <option value="">Tất cả thương hiệu</option>
                                @foreach (var brand in (List<PhuLieuToc.Models.BrandModel>)ViewBag.Brands)
                                {
                                    var isSelected = ViewBag.SelectedBrandId?.ToString() == brand.Id.ToString();
                                    <option value="@brand.Id" selected="@isSelected">
                                        @brand.TenThuongHieu
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tìm kiếm</label>
                            <input type="text" name="search" class="form-control" placeholder="Nhập tên sản phẩm..." value="@ViewBag.SearchTerm">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    @if (Model.Any())
    {
        <div class="row">
            @foreach (var product in Model)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="card h-100 product-card">
                        <div class="product-image-container">
                            @{ var firstVariant = product.SanPhamChiTiets?.Where(v => v.TrangThai == 1).OrderBy(v => v.SanPhamChiTietId).FirstOrDefault(); }
                            @if (!string.IsNullOrEmpty(firstVariant?.Anh))
                            {
                                <img src="@Url.Content(firstVariant.Anh)" alt="@product.TenSanPham" class="card-img-top product-image" style="width:100%;height:200px;object-fit:cover;">
                            }
                            else
                            {
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center product-image">
                                    <i class="fas fa-image fa-2x text-muted"></i>
                                </div>
                            }
                            <div class="product-overlay">
                                @if (firstVariant != null) {
                                <a href="@Url.Action("Details", new { id = firstVariant.SanPhamChiTietId })" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>Xem chi tiết
                                </a>
                                }
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">@product.TenSanPham</h6>
                            
                            @if (firstVariant?.SanPhamChiTietThuocTinhs != null && firstVariant.SanPhamChiTietThuocTinhs.Any())
                            {
                                <p class="card-text text-muted small">@string.Join(", ", firstVariant.SanPhamChiTietThuocTinhs.Select(t => t.GiaTriThuocTinh.TenGiaTri))</p>
                            }
                            
                            @if (!string.IsNullOrEmpty(product.Brand?.TenThuongHieu))
                            {
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-tag me-1"></i>@product.Brand.TenThuongHieu
                                    </small>
                                </p>
                            }
                            
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="h5 text-primary mb-0">@(firstVariant?.Gia.ToString("N0") ?? "0") ₫</span>
                                    <small class="text-muted">Còn: @(firstVariant?.SoLuongTon ?? 0)</small>
                                </div>
                                
                                @if ((firstVariant?.SoLuongTon ?? 0) > 0)
                                {
                                    <button class="btn btn-outline-primary w-100" onclick="openVariantOrAdd(@product.SanPhamId, @firstVariant.SanPhamChiTietId)">
                                        <i class="fas fa-shopping-cart me-1"></i>Thêm vào giỏ
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-secondary w-100" disabled>
                                        <i class="fas fa-times me-1"></i>Hết hàng
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Không tìm thấy sản phẩm</h4>
                    <p class="text-muted">Hãy thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                    <a href="@Url.Action("Index")" class="btn btn-primary">
                        <i class="fas fa-refresh me-2"></i>Xem tất cả sản phẩm
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .product-card {
        transition: transform 0.2s ease-in-out;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .product-image-container {
        position: relative;
        overflow: hidden;
    }
    
    .product-image {
        height: 200px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .product-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .product-card:hover .product-overlay {
        opacity: 1;
    }
    
    .product-card:hover .product-image {
        transform: scale(1.1);
    }
</style>

@section Scripts {
    <script>
        async function openVariantOrAdd(productId, defaultVariantId) {
            try {
                const res = await fetch('@Url.Action("GetVariants","Product")' + `?productId=${productId}`);
                const data = await res.json();
                if (!data.success) return addToCart(defaultVariantId);
                if (!data.variants || data.variants.length === 0) return addToCart(defaultVariantId);
                if (data.variants.length === 1) {
                    const onlyId = data.variants[0]?.id || defaultVariantId;
                    return addToCart(onlyId);
                }

                const variants = data.variants;
                const html = `
<div class="modal fade" id="variantModal" tabindex="-1">
 <div class="modal-dialog">
  <div class="modal-content">
   <div class="modal-header"><h5 class="modal-title">Chọn biến thể</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
   <div class="modal-body">
     ${variants.map(v => `<div class='form-check'>
        <input class='form-check-input' type='radio' name='variantOption' value='${v.id}' id='v_${v.id}'>
        <label class='form-check-label' for='v_${v.id}'>${v.thuocTinh.map(t=>`${t.loai}: ${t.giaTri}`).join(', ')} - ${Number(v.gia).toLocaleString()} (${v.soLuongTon} tồn)</label>
     </div>`).join('')}
   </div>
   <div class="modal-footer">
     <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
     <button type="button" class="btn btn-primary" id="variantAddBtn">Thêm vào giỏ</button>
   </div>
  </div>
 </div>
</div>`;
                const container = document.createElement('div');
                container.style.position = 'relative';
                container.style.zIndex = '1056';
                container.innerHTML = html;
                document.body.appendChild(container);
                const modalEl = container.querySelector('#variantModal');
                const modal = new bootstrap.Modal(modalEl, {backdrop:true,focus:true});
                container.querySelector('#variantAddBtn').addEventListener('click', () => {
                    const checked = container.querySelector("input[name='variantOption']:checked");
                    if (!checked) return;
                    addToCart(checked.value);
                    modal.hide();
                    container.remove();
                });
                modalEl.addEventListener('hidden.bs.modal', () => container.remove());
                modal.show();
                setTimeout(() => {
                    if (!modalEl.classList.contains('show')) {
                        modalEl.classList.add('show');
                        modalEl.style.display = 'block';
                        modalEl.removeAttribute('aria-hidden');
                        modalEl.setAttribute('aria-modal', 'true');
                        const bd = document.createElement('div');
                        bd.className = 'modal-backdrop fade show';
                        document.body.appendChild(bd);
                    }
                }, 50);
            } catch (e) {
                addToCart(defaultVariantId);
            }
        }

        function addToCart(sanPhamChiTietId) {
            fetch('@Url.Action("AddToCart", "Cart")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `sanPhamChiTietId=${sanPhamChiTietId}&soLuong=1`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (window.showToast) window.showToast(data.message, 'success');
                    if (window.updateCartCount) window.updateCartCount();
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi thêm vào giỏ hàng');
            });
        }
    </script>
}